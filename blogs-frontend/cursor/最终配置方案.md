# æœ€ç»ˆé…ç½®æ–¹æ¡ˆ - ç¦ç”¨ HTML ç¼“å­˜

## ğŸ“‹ å½“å‰æƒ…å†µåˆ†æ

æ ¹æ®ä¸»é…ç½®æ–‡ä»¶ï¼Œå‘ç°ï¼š
- âœ… å·²æœ‰ `location /` ä»£ç†é…ç½®ï¼ˆä»£ç†åˆ° `http://127.0.0.1:3000`ï¼‰
- âœ… æœ‰ç¼“å­˜æ¸…é™¤è§„åˆ™ `location ~ /purge(/.*)`ï¼Œè¯´æ˜å¯ç”¨äº†ä»£ç†ç¼“å­˜
- âœ… æ‰©å±•é…ç½®æ–‡ä»¶ä¼šè¢« `include` åˆ°ä¸»é…ç½®ä¸­

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

ç”±äºä¸»é…ç½®æ–‡ä»¶ä¸­çš„ `location /` æ²¡æœ‰ç¦ç”¨ç¼“å­˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨**æ‰©å±•é…ç½®æ–‡ä»¶**ä¸­æ·»åŠ é…ç½®æ¥è¦†ç›–å®ƒã€‚

### æ–¹æ³•ï¼šåœ¨æ‰©å±•é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ›´å…·ä½“çš„é…ç½®

æ‰©å±•é…ç½®æ–‡ä»¶ä¸­çš„ `location` å—ä¼šä¸ä¸»é…ç½®åˆå¹¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ç¼“å­˜æ§åˆ¶å¤´æ¥ç¦ç”¨ HTML ç¼“å­˜ã€‚

## âœ… å…·ä½“æ“ä½œæ­¥éª¤

### æ­¥éª¤ 1ï¼šå¤‡ä»½æ‰©å±•é…ç½®æ–‡ä»¶

```bash
cp /www/server/panel/vhost/nginx/extension/frontend/*.conf /www/server/panel/vhost/nginx/extension/frontend/*.conf.bak
```

### æ­¥éª¤ 2ï¼šç¼–è¾‘æ‰©å±•é…ç½®æ–‡ä»¶

**æ–¹å¼ Aï¼šä½¿ç”¨å®å¡”é¢æ¿ï¼ˆæ¨èï¼‰**
1. ç™»å½•å®å¡”é¢æ¿
2. ç½‘ç«™ â†’ æ‰¾åˆ° `frontend` ç«™ç‚¹ â†’ è®¾ç½®
3. é…ç½®ä¿®æ”¹ â†’ **æ‰©å±•é…ç½®**ï¼ˆä¸æ˜¯ä¸»é…ç½®ï¼‰
4. æ·»åŠ ä»¥ä¸‹é…ç½®

**æ–¹å¼ Bï¼šä½¿ç”¨å‘½ä»¤è¡Œ**
```bash
vi /www/server/panel/vhost/nginx/extension/frontend/*.conf
```

### æ­¥éª¤ 3ï¼šæ·»åŠ ä»¥ä¸‹é…ç½®

åœ¨æ‰©å±•é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼ˆä¿ç•™åŸæœ‰çš„ `access_log` è¡Œï¼‰ï¼š

```nginx
access_log syslog:server=unix:/tmp/site_total.sock,nohostname,tag=7__access site_total;

# è¦†ç›–ä¸»é…ç½®çš„ location /ï¼Œç¦ç”¨ HTML ç¼“å­˜
location / {
    # ç»§æ‰¿ä¸»é…ç½®çš„ä»£ç†è®¾ç½®ï¼Œä½†æ·»åŠ ç¼“å­˜æ§åˆ¶
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header X-Host $host:$server_port;
    proxy_set_header X-Scheme $scheme;
    proxy_connect_timeout 30s;
    proxy_read_timeout 86400s;
    proxy_send_timeout 30s;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # å…³é”®ï¼šç¦ç”¨ç¼“å­˜ HTML
    proxy_cache_bypass $http_upgrade;
    proxy_no_cache $http_upgrade;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    # ç§»é™¤ç¼“å­˜çŠ¶æ€å¤´ï¼ˆå¦‚æœä¸»é…ç½®æ·»åŠ äº†ï¼‰
    add_header X-Cache "BYPASS" always;
}

# åªç¼“å­˜é™æ€èµ„æºï¼ˆJS/CSS/å›¾ç‰‡ï¼‰
location /_next/static/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # å¯ç”¨é™æ€èµ„æºç¼“å­˜
    proxy_cache cache_one;
    proxy_cache_valid 200 30d;
    proxy_cache_key "$scheme$request_method$host$request_uri";
    expires 30d;
    add_header Cache-Control "public, immutable" always;
    add_header X-Cache $upstream_cache_status always;
}
```

### æ­¥éª¤ 4ï¼šæµ‹è¯•é…ç½®

```bash
# æµ‹è¯• Nginx é…ç½®æ˜¯å¦æ­£ç¡®
nginx -t
```

å¦‚æœæ˜¾ç¤º `syntax is ok` å’Œ `test is successful`ï¼Œè¯´æ˜é…ç½®æ­£ç¡®ã€‚

### æ­¥éª¤ 5ï¼šæ¸…é™¤ç°æœ‰ç¼“å­˜å¹¶é‡è½½

```bash
# æ¸…é™¤ä»£ç†ç¼“å­˜
rm -rf /www/server/nginx/proxy_cache_dir/*
mkdir -p /www/server/nginx/proxy_cache_dir

# é‡æ–°åŠ è½½ Nginx
nginx -s reload
```

### æ­¥éª¤ 6ï¼šéªŒè¯

```bash
# æµ‹è¯•æœ¬åœ°æœåŠ¡
curl -s http://localhost:3000 | grep -o "ä½ å¥½ï¼Œæˆ‘æ˜¯"

# æµ‹è¯•å…¬ç½‘è®¿é—®ï¼ˆé€šè¿‡ Nginxï¼‰
curl -I http://119.91.150.19 | grep -i "cache-control"

# åº”è¯¥çœ‹åˆ°ï¼šCache-Control: no-cache, no-store, must-revalidate
```

## ğŸ“ ç®€åŒ–ç‰ˆæœ¬ï¼ˆå¦‚æœä¸Šé¢çš„é…ç½®æœ‰å†²çªï¼‰

å¦‚æœä¸Šé¢çš„é…ç½®å¯¼è‡´å†²çªï¼Œå¯ä»¥ä½¿ç”¨æ›´ç®€å•çš„ç‰ˆæœ¬ï¼Œåªæ·»åŠ ç¼“å­˜æ§åˆ¶å¤´ï¼š

```nginx
access_log syslog:server=unix:/tmp/site_total.sock,nohostname,tag=7__access site_total;

# åªæ·»åŠ ç¼“å­˜æ§åˆ¶ï¼Œä¸è¦†ç›–æ•´ä¸ª location
location / {
    # ç¦ç”¨ç¼“å­˜ HTML
    proxy_cache_bypass $http_upgrade;
    proxy_no_cache $http_upgrade;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}
```

## âš ï¸ é‡è¦è¯´æ˜

1. **æ‰©å±•é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§**ï¼šæ‰©å±•é…ç½®æ–‡ä»¶ä¸­çš„ `location` å—ä¼šä¸ä¸»é…ç½®åˆå¹¶ï¼Œå¦‚æœåŒåï¼Œæ‰©å±•é…ç½®ä¼šè¦†ç›–ä¸»é…ç½®
2. **ä½¿ç”¨ `always` å‚æ•°**ï¼š`add_header` æŒ‡ä»¤é»˜è®¤åªåœ¨æˆåŠŸå“åº”æ—¶æ·»åŠ ï¼Œä½¿ç”¨ `always` ç¡®ä¿æ‰€æœ‰å“åº”éƒ½æ·»åŠ ç¼“å­˜æ§åˆ¶å¤´
3. **å¦‚æœé…ç½®å†²çª**ï¼šå…ˆä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬ï¼Œå¦‚æœä¸è¡Œå†ä½¿ç”¨å®Œæ•´ç‰ˆæœ¬

## ğŸ¯ æ‰§è¡Œé¡ºåº

1. âœ… **å…ˆæ¸…é™¤ç°æœ‰ç¼“å­˜**ï¼ˆè§£å†³å½“å‰é—®é¢˜ï¼‰
   ```bash
   rm -rf /www/server/nginx/proxy_cache_dir/*
   nginx -s reload
   ```

2. âœ… **ç„¶åæ·»åŠ æ‰©å±•é…ç½®**ï¼ˆé¿å…ä»¥åæ¯æ¬¡éƒ½è¦æ‰‹åŠ¨æ¸…é™¤ï¼‰

3. âœ… **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼Œè®¿é—®éªŒè¯
